% -*- mode: latex; TeX-master: t; -*-

% \documentclass[notes=hide]{beamer}
% \documentclass[notes=only]{beamer}
\documentclass[
14pt,
aspectratio=169,
usenames,
dvipsnames,
% handout,
x11names]{beamer}
%\let\Tiny=\tiny

% Font selection
\overfullrule=5pt

\usepackage{etex}
\usepackage{pgfpages}

\usepackage{tabularx}
\usepackage{multicol}
% \usepackage[subfolder]{gnuplottex}

%% beamerscape dependencies
\usepackage[absolute,overlay]{textpos}
\setlength{\TPHorizModule}{\paperwidth}
\setlength{\TPVertModule}{\paperheight}
\textblockorigin{0mm}{0mm}

\definecolor{greenvm}{HTML}{AFD18E}
\definecolor{g}{HTML}{0E3B12}
\definecolor{v}{HTML}{003366}

\newcommand{\src}[1]{\scriptsize Figure Source: \textit{#1}}

\input{theme/beamerpreamble}

\renewcommand{\footnoterule}{}

\usepackage{hyperref}
\hypersetup{
  linktoc=all,
  bookmarks=false,           % show bookmarks bar?
  bookmarksopen,
  bookmarksnumbered,
  colorlinks = false,
  linkcolor=black,           % color of interlinks
  citecolor=black,           % color of the sitation links
  urlcolor=black,            % the url color
  unicode=true,              % non-Latin characters in Acrobat’s bookmarks
  pdftoolbar=true,           % show Acrobat’s toolbar?
  pdfmenubar=true,           % show Acrobat’s menu?
  pdffitwindow=true,         % window fit to page when opened
  pdftitle={Managed Runtime Systems},  % title
  pdfborder={ 0 0 0 },        % uBorder tin links
  pdfauthor = {Foivos Zakkak},
  pdfcreator = {Foivos Zakkak},
}

\usefonttheme{professionalfonts}% use own font handling
\usepackage{fontspec}
% \setmainfont{Comfortaa}
% \setsansfont{Comfortaa}
% \setsansfont{Liberation Sans}
\setmainfont[
% SmallCapsFont={Linux Biolinum},
SmallCapsFeatures={Letters=SmallCaps},
]{Liberation Sans}
% \setmonofont{Liberation Mono}
% \setmonofont{Inconsolata LGC for Powerline}
% Math fonts
\usepackage{unicode-math}
\setmathfont{xits-math.otf}

\usepackage{graphicx}
\usepackage{ulem}
\usepackage{color}
\usepackage{xspace}
\usepackage{xcolor}
\usepackage{array}
\usepackage{tikz}
\usetikzlibrary{arrows,arrows.meta,shapes,decorations,decorations.pathmorphing,calc,shadows,shadows.blur,shapes.multipart,positioning,patterns,fit,backgrounds,trees,shapes}
\usepackage{pgfplots}

\tikzset{
    %Define standard arrow tip
    >=stealth',
    % Define arrow style
    arrow/.style={
           ->,
           thick,
           color=uompurple,
           shorten <=2pt,
           shorten >=4pt,},
    % Daniel's proposal for "uncovering" parts of a tikz-tree %
    invisible/.style={opacity=0},
    visible on/.style={alt=#1{}{invisible}},
    alt/.code args={<#1>#2#3}{%
      \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}} % \pgfkeysalso doesn't change the path
    },
  }
\pgfdeclaredecoration{penciline}{initial}{
    \state{initial}[width=+\pgfdecoratedinputsegmentremainingdistance,
    auto corner on length=1mm,]{
        \pgfpathcurveto%
        {% From
            \pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}
                      {\pgfdecorationsegmentamplitude}
        }
        {%  Control 1
        \pgfmathrand
        \pgfpointadd{\pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}{0pt}}
                    {\pgfqpoint{-\pgfdecorationsegmentaspect
                     \pgfdecoratedinputsegmentremainingdistance}%
                               {\pgfmathresult\pgfdecorationsegmentamplitude}
                    }
        }
        {%TO
        \pgfpointadd{\pgfpointdecoratedinputsegmentlast}{\pgfpoint{1pt}{1pt}}
        }
    }
    \state{final}{}
  }
\usepackage{amsmath}
\usepackage{textpos}
% \usepackage{subfigure}

\graphicspath{{figures/}}
% \newcommand{\longname}{\emph{Source-Level Compiler Optimizations for Task-Parallelism}}
\newcommand{\java}[0]{Java\texttrademark\xspace}
\newcommand{\code}[1]{{\colorbox{black}{\color{green}\texttt{#1}}}}

\usepackage{bbding} % for the Checkmark and XSolidBrush
\newcommand{\tik}[0]{{\color{YellowGreen}\Checkmark}} % Check-mark
\newcommand{\ex}[0]{{\color{BrickRed}\XSolidBrush}}  % X-mark

% \usepackage{verbatim}
\usepackage{listings}
\lstset{
  language=c,
  basicstyle=\small\ttfamily,
%  columns=flexible,
  % numbers=left,
  % numberstyle=\ttfamily\tiny,
  showstringspaces=false,
  alsoletter={-},
  literate={-}{-}1,
%  numbersep=1em,
  xleftmargin=2em,
%  xrightmargin=1em,
  escapeinside={@}{@},
%  morecomment=[l][\color{BrickRed}]{\#pragma\ task},
  commentstyle=\color{black},
  morekeywords={final, transient, synthetic},
%   identifierstyle=\color{green},
%  backgroundcolor=\color{Honeydew1},
  keywordstyle=\bfseries\color{myyellow},
  stringstyle=\color{YellowGreen},
%  moredelim=**[is][\only<+(1)->{\color{black}\lstset{style=highlight}}]{~}{~},
}

\usepackage{booktabs} % bottomrule
\usepackage{multirow}

% Print table of contects at the beggining of each section
% \AtBeginSection[]{\begin{frame}\frametitle{Table of Contents}\tableofcontents[currentsection,currentsubsection]\end{frame}}
% \AtBeginSubsection[]{\begin{frame}\frametitle{Table of Contents}\tableofcontents[currentsection,currentsubsection]\end{frame}}

% Add outlines
% \AtBeginSection[]
% {
%   {
%   \setbeamertemplate{footline}{}
%   \begin{frame}<beamer>[plain,noframenumbering]
%     \frametitle{Outline}
%     \tableofcontents[currentsection]
%   \end{frame}
%   }
% }
\setcounter{tocdepth}{1}

%%%%%%%%%%%%%%%
% Intro slide %
%%%%%%%%%%%%%%%

\title{Managed Runtime Systems}
\subtitle{Lecture 10: Java Concurrency}
\author[\url{https://foivos.zakkak.net}]{Foivos Zakkak}
% \institute[]{ManLang'17}
\date{\url{https://foivos.zakkak.net}}
% \logo{\includegraphics[height=1.0cm]{uniman-logo}}
% % Spread those bullets
% \let\olditem\item
% \renewcommand{\item}{\setlength{\itemsep}{\fill}\olditem}

\begin{document}
\setbeamercovered{invisible}

% \maketitle

\begin{frame}[plain]
  \titlepage
  \centering
  \includegraphics[height=.75cm]{cc}~
  \includegraphics[height=.75cm]{by}\\[1em]
  % \includegraphics[height=.75cm]{nc-eu}~
  % \includegraphics[height=.75cm]{sa}\\[1em]
  \scriptsize{Except where otherwise noted, this presentation is licensed under the\\
    \href{http://creativecommons.org/licenses/by/4.0/}%
    {Creative Commons Attribution 4.0 International License.}\\[1ex]
    Third party marks and brands are the property of their respective
    holders.}
\end{frame}

% \begin{frame}[plain,noframenumbering]{Outline}
%     \tableofcontents
% \end{frame}

\section{Introduction}

\begin{frame}{Java Concurrency}
  Built-in
  \vfill
  Through standard libraries
  \vfill
  Through third party libraries
\end{frame}

\section{Built-in Java Concurrency}

\begin{frame}{Built-in Java Concurrency}
  Synchronized methods:\\
  \code{public synchronized void foo() {...}}
  \vfill
  Synchronized block:\\
  \code{synchronized(barObject) {...}}
  \vfill
  Volatile variables:\\
  \code{volatile int volatileInteger;}
  \vfill
  Java Threads:\\
  \code{myThread.start(); myThread.join(); ...}
  \vfill
  Object wait/notify:\\
  \code{myObject.wait(); myObject.notify(); ...}
\end{frame}

\begin{frame}{Java Threads}
  Can be started only once
  \vfill
  Can have different priorities 1-10, default is 5
  \vfill
  See also: \code{Thread.MIN\_PRIORITY}, \code{Thread.NORMAL\_PRIORITY}, \code{Thread.MAX\_PRIORITY}
  \vfill
  However, priorities are not guaranteed to be taken into account
\end{frame}

\begin{frame}{Java Threads}
  \code{Thread.sleep(duration)} Stop for \code{duration} milliseconds
  \vfill
  \code{Thread.yield()} Let the JVM know that we are willing to stop running to allow other threads to run
  \vfill
  \code{myThread.join()} Pause current thread till the completion of myThread (it can also be given a timeout as argument)
\end{frame}

\begin{frame}{Java Objects}
  \code{myObject.wait()} Pause execution till notified (it can also be given a timeout as argument). Wait implicitly releases any locks owned by current thread and re-acquires them on notification.
  \vfill
  \code{myObject.notify()} Notify one of the waiting threads to resume execution
  \vfill
  \code{myObject.notifyAll()} Notify all the waiting threads
\end{frame}

\section{Standard Libraries}

\begin{frame}{Standard Libraries}
  Vector and Hashtable are thread-safe
  \vfill
  \url{https://docs.oracle.com/javase/8/docs/api/java/util/Vector.html}
  \url{https://docs.oracle.com/javase/8/docs/api/java/util/Hashtable.html}
\end{frame}

\begin{frame}{Standard Libraries}
  Thread-safe Collections: \code{java.util.Collections.synchronized*}
  \vfill
  \url{https://docs.oracle.com/javase/8/docs/api/java/util/Collections.html}
\end{frame}

\begin{frame}[fragile]{Be Careful Though!}
\begin{lstlisting}
public Object getLast(Vector vector) {
    int lastIndex = vector.size() - 1;
    return vector.get(lastIndex);
}

public void deleteLast(Vector vector) {
    int lastIndex = vector.size() - 1;
    list.remove(lastIndex);
}
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Be Careful Though!}
\begin{lstlisting}
public Object getLast(Vector vector) {
    synchronized (vector) {
        int lastIndex = vector.size() - 1;
        return vector.get(lastIndex);
    }
}

public void deleteLast(Vector vector) {
    synchronized (vector) {
        int lastIndex = vector.size() - 1;
        vector.remove(lastIndex);
    }
}
\end{lstlisting}
\end{frame}

\begin{frame}{Standard Libraries}
  Atomic variables: \code{java.util.concurrent.atomic}
  \vfill
  \url{https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/package-summary.html}
\end{frame}

\begin{frame}{Standard Libraries}
  More locks: \code{java.util.concurrent.locks}
  \vfill
  \url{https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/package-summary.html}
\end{frame}

\begin{frame}{Standard Libraries}
  Concurrent Collections: \code{java.util.concurrent}
  \vfill
  \url{https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html}
\end{frame}

\begin{frame}{Concurrent Collections}
  \code{ConcurrentMap}: set with no duplicates
  \vfill
  \code{ConcurrentHashMap}: hash-based set with no duplicates
  \vfill
  \code{BlockingQueue}: producer-consumer
  \vfill
  \code{CopyOnWriteArrayList}: optimized synchronized list
\end{frame}

\begin{frame}{CountDownLatch}
  Blocks threads that invoke \code{await()}
  \vfill
  Threads unblock when latch reaches zero through \code{countDown()}
\end{frame}

\begin{frame}{Semaphore}
  A counting semaphore, allowing a fixed number of threads to proceed
\end{frame}

\begin{frame}{CyclicBarrier}
  Blocks till a number of threads reach the barrier and then continues
\end{frame}

\begin{frame}{Phaser}
  Like CyclicBarrier but the number of threads that need to reach the barrier can change over time
\end{frame}

\begin{frame}{Exchanger}
  Block till another thread reaches the exchange point and exchange an object
\end{frame}

\begin{frame}{Executor Framework}
  Create and manage tasks
  \vfill
  Various thread pools to schedule executors on
\end{frame}

\begin{frame}{Futures}
  Tasks that return a value
  \vfill
  We can see if a \texttt{Future} is complete and get its value
  \vfill
  We can wait a \texttt{Future}
  \vfill
  We can cancel a \texttt{Future}
\end{frame}

\begin{frame}{More!!!}
\url{https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html}
\end{frame}

\subsection{Memory Model}

\begin{frame}{Memory Model 1/2}
  \small

  The methods of all classes in \texttt{java.util.concurrent} and its
  subpackages extend these guarantees to higher-level
  synchronization. In particular:

  \begin{itemize}
  \item Actions in a thread prior to placing an object into any
    concurrent collection \alert{happen-before} actions subsequent to the access
    or removal of that element from the collection in another thread

  \item Actions in a thread prior to the submission of a Runnable to an
    Executor \alert{happen-before} its execution begins. Similarly for
    \texttt{Callable}s submitted to an \texttt{ExecutorService}

  \item Actions taken by the asynchronous computation represented by a
    \texttt{Future} \alert{happen-before} actions subsequent to the
    retrieval of the result via \texttt{Future.get()} in another thread
  \end{itemize}
\end{frame}

\begin{frame}{Memory Model 2/2}
  \small
  \begin{itemize}
  \item Actions prior to "releasing" synchronizer methods such as
    \texttt{Lock.unlock}, \texttt{Semaphore.release}, and
    \texttt{CountDownLatch.countDown} \alert{happen-before} actions
    subsequent to a successful "acquiring" method such as
    \texttt{Lock.lock}, \texttt{Semaphore.acquire},
    \texttt{Condition.await}, and \texttt{CountDownLatch.await} on the
    same synchronizer object in another thread

  \item For each pair of threads that successfully exchange objects via
    an \texttt{Exchanger}, actions prior to the \texttt{exchange()} in
    each thread \alert{happen-before} those subsequent to the
    corresponding \texttt{exchange()} in another thread

  \item Actions prior to calling \texttt{CyclicBarrier.await} and
    \texttt{Phaser.awaitAdvance} (as well as its variants)
    \alert{happen-before} actions performed by the barrier action, and
    actions performed by the barrier action \alert{happen-before}
    actions subsequent to a successful return from the corresponding
    await in other threads
  \end{itemize}
\end{frame}

\section{Third Party Libraries}

\begin{frame}{Third Party Libraries}
  Threadly (\url{https://threadly.github.io/threadly/})
  \vfill
  JCTools (\url{https://github.com/JCTools/JCTools})
  \vfill
  ...
\end{frame}

% Closing slide
% \subsection{Closure}
% % {
% % \setbeamertemplate{footline}{}
% % \begin{frame}[noframenumbering]
% %  \frametitle{\fontspec{Purisa}\textbf{Thank You!}}
% %  \centering
% %  \titlepage
% % \end{frame}
% % }
% \begin{frame}
%   % \centering
%   \Huge
%   \alert{Can managed programming languages run on future
%   many-core architectures?}
%   % \vspace{-2em}
%   \vfill
%   \begin{flushright}
%     \fontspec{Purisa}\structure{Thank You!}
%   \end{flushright}
% \end{frame}

%   BACKUP SLIDES

\end{document}
